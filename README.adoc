:toc:
:project_id: gs-spring-boot-docker
:icons: font
:source-highlighter: prettify

* goal
    ** build a Spring Boot application's https://docker.com[Docker] image -- via --
        *** docker build
        *** build plugins (Maven & Gradle)

* see https://spring.io/guides/topicals/spring-boot-docker[ALSO ]

== What You Will Need
* :java_version: 17
include::https://raw.githubusercontent.com/spring-guides/getting-started-macros/main/prereq_editor_jdk_buildtools.adoc[]

* https://docker.com[Docker]

[[scratch]]
== Starting with Spring Initializr

* https://start.spring.io/#!type=maven-project&language=java&packaging=jar&jvmVersion=11&groupId=com.example&artifactId=spring-boot-docker&name=spring-boot-docker&description=Demo%20project%20for%20Spring%20Boot&packageName=com.example.spring-boot-docker&dependencies=web[Spring Initializr]
** click -- to -- generate to download a ZIP file
** choose either Gradle or Maven
** *Dependencies*: *Spring Web*
** Download the resulting ZIP file

[[initial]]
== Set up a Spring Boot Application

* create
+
====
`src/main/java/hello/Application.java`
[source,java,tabsize=2]
----
include::complete/src/main/java/hello/Application.java[]
----
====

* run the application WITHOUT Docker container
** -- via -- Gradle
+
====
[bash,subs="attributes"]
----
./gradlew build && java -jar build/libs/{project_id}-0.1.0.jar
----
====
** -- via -- Maven
+
====
[bash,subs="attributes"]
----
./mvnw package && java -jar target/{project_id}-0.1.0.jar
----
====

* http://localhost:8080[localhost:8080]
** see "`Hello Docker World`" message

== Containerize It

* https://docs.docker.com/reference/builder/["Dockerfile"]
** == file format
** uses
*** specify the image's "`layers`"
+
.Dockerfile
====
[source]
----
FROM openjdk:8-jdk-alpine
ARG JAR_FILE=target/*.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
----
====

* if you
** use Gradle -> run
+
====
[source,bash,subs="attributes"]
----
docker build --build-arg JAR_FILE=build/libs/\*.jar -t springio/gs-spring-boot-docker .
----
====

** use Maven -> run
+
====
[source,bash,subs="attributes"]
----
docker build -t springio/gs-spring-boot-docker .
----
====

* `Dockerfile` / non-root user
+
.Dockerfile
====
[source]
----
FROM openjdk:8-jdk-alpine
RUN addgroup -S spring && adduser -S spring -G spring
USER spring:spring
ARG JAR_FILE=target/*.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
----
====

** build & run
+
====
[source,bash]
----
docker build -t springio/gs-spring-boot-docker .
docker run -p 8080:8080 springio/gs-spring-boot-docker
----
====

* Spring Boot fat JAR file's dependencies !=  Spring Boot fat JAR file's application resources
    ** -> create layers | container filesystem / the MOST slow changing resources layered BEFORE -> improve performance
        *** Reason:🧠layers are cached | build time & runtime🧠
+
.Dockerfile
====
[source]
----
include::complete/Dockerfile[]
----
====

    ** `DEPENDENCY` parameter
        *** point to a directory | we have unpacked the fat JAR
        *** use it -- via --
            **** Gradle
+
====
[source,bash]
----
mkdir -p build/dependency && (cd build/dependency; jar -xf ../libs/*.jar)
----
====
            **** Maven
+
====
[source,bash]
----
mkdir -p target/dependency && (cd target/dependency; jar -xf ../*.jar)
----
====

* build the image
    *** -- via -- Dockerfile
        **** | Gradle
+
====
[source,bash]
----
docker build --build-arg DEPENDENCY=build/dependency -t springio/gs-spring-boot-docker .
----
====
        **** | Maven
+
====
[source,bash]
----
docker build -t springio/gs-spring-boot-docker .
----
====
    *** -- via -- build plugin (buildpacks)
        **** | https://docs.spring.io/spring-boot/docs/2.3.0.RELEASE/gradle-plugin/reference/html/#build-image[Gradle]
+
====
[source,bash]
----
./gradlew bootBuildImage --imageName=springio/gs-spring-boot-docker
----
====

        **** | https://docs.spring.io/spring-boot/docs/2.3.0.RELEASE/maven-plugin/reference/html/#build-image[Maven]
+
====
[source,bash]
----
./mvnw spring-boot:build-image -Dspring-boot.build-image.imageName=springio/gs-spring-boot-docker

# if you want to push | some Docker registry
#./mvnw spring-boot:build-image -Dspring-boot.build-image.imageName=dancer13/gs-spring-boot-docker
----
====

=== After the Push

* ❌NOT required❌

* run
+
====
[source,bash]
----
$ docker run -p 8080:8080 -t springio/gs-spring-boot-docker
Container memory limit unset. Configuring JVM for 1G container.
Calculated JVM Memory Configuration: -XX:MaxDirectMemorySize=10M -XX:MaxMetaspaceSize=86381K -XX:ReservedCodeCacheSize=240M -Xss1M -Xmx450194K (Head Room: 0%, Loaded Class Count: 12837, Thread Count: 250, Total Memory: 1073741824)
....
2015-03-31 13:25:48.035  INFO 1 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)
2015-03-31 13:25:48.037  INFO 1 --- [           main] hello.Application                        : Started Application in 5.613 seconds (JVM running for 7.293)
----
====
    ** buildpack
        *** | runtime, size the JVM -- via -- memory calculator / fit the container


When it is running, you can see in the list of containers, similar to the following example:

====
[source,bash]
----
$ docker ps
CONTAINER ID        IMAGE                                   COMMAND                  CREATED             STATUS              PORTS                    NAMES
81c723d22865        springio/gs-spring-boot-docker:latest   "java -Djava.secur..."   34 seconds ago      Up 33 seconds       0.0.0.0:8080->8080/tcp   goofy_brown
----
====

To shut it down again, you can run `docker stop` with the container ID from the previous listing (yours will be different):

====
[source,bash]
----
docker stop goofy_brown
81c723d22865
----
====

If you like, you can also delete the container (it is persisted in your filesystem somewhere under `/var/lib/docker`) when you are finished with it:

====
[source,bash]
----
docker rm goofy_brown
----
====

=== Using Spring Profiles

Running your freshly minted Docker image with Spring profiles is as easy as passing an environment variable to the Docker run command (for the `prod` profile):

====
[source,bash]
----
docker run -e "SPRING_PROFILES_ACTIVE=prod" -p 8080:8080 -t springio/gs-spring-boot-docker
----
====

You can do the same for the `dev` profile:

====
----
docker run -e "SPRING_PROFILES_ACTIVE=dev" -p 8080:8080 -t springio/gs-spring-boot-docker
----
====

=== Debugging the Application in a Docker Container

* debug the application -- via -- https://docs.oracle.com/javase/8/docs/technotes/guides/jpda/conninv.html#Invocation[JPDA Transport]
    ** requirements
        *** pass Java agent settings | `JAVA_TOOL_OPTIONS`
        *** map the agent's port -- to -- localhost
        *** | https://www.docker.com/products/docker#/mac[Docker for Mac], https://github.com/docker/for-mac/issues/171[black magic usage]
            **** Reason:🧠access the container by IP🧠
+
====
[source,bash]
----
docker run -e "JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,address=5005,server=y,suspend=n" -p 8080:8080 -p 5005:5005 -t springio/gs-spring-boot-docker
----
====

== Summary

Congratulations! You have created a Docker container for a Spring Boot application! By default, Spring Boot applications run on port 8080 inside the container, and we mapped that to the same port on the host by using `-p` on the command line.

== See Also

The following guides may also be helpful:

* https://spring.io/guides/gs/serving-web-content/[Serving Web Content with Spring MVC]
* https://spring.io/guides/gs/spring-boot/[Building an Application with Spring Boot]
* https://spring.io/guides/topicals/spring-boot-docker[Topical Guide on Spring Boot with Docker] (more depth than this guide)

include::https://raw.githubusercontent.com/spring-guides/getting-started-macros/main/footer.adoc[]
